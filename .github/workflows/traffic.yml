name: Persist GitHub Traffic Data

on:
  schedule:
    - cron: '0 1 * * *'  # Täglich um 01:00 UTC
  workflow_dispatch:  # Manuell auslösbar

permissions:
  contents: write

jobs:
  traffic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch and persist traffic data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          REPO="${{ github.repository }}"

          mkdir -p .github/traffic

          # Traffic-Daten abrufen
          VIEWS=$(gh api "repos/$REPO/traffic/views" 2>/dev/null) || VIEWS='{"count":0,"uniques":0,"views":[]}'
          CLONES=$(gh api "repos/$REPO/traffic/clones" 2>/dev/null) || CLONES='{"count":0,"uniques":0,"clones":[]}'
          REFERRERS=$(gh api "repos/$REPO/traffic/popular/referrers" 2>/dev/null) || REFERRERS='[]'
          PATHS=$(gh api "repos/$REPO/traffic/popular/paths" 2>/dev/null) || PATHS='[]'

          # Stars und Forks abrufen
          STARS=$(gh api "repos/$REPO" --jq '.stargazers_count' 2>/dev/null) || STARS='0'
          FORKS=$(gh api "repos/$REPO" --jq '.forks_count' 2>/dev/null) || FORKS='0'

          # Tages-Snapshot als JSONL (eine Zeile pro Tag, einfach appendbar)
          SNAPSHOT=$(jq -n \
            --arg date "$DATE" \
            --argjson views "$VIEWS" \
            --argjson clones "$CLONES" \
            --argjson referrers "$REFERRERS" \
            --argjson paths "$PATHS" \
            --argjson stars "$STARS" \
            --argjson forks "$FORKS" \
            '{date: $date, views: $views, clones: $clones, referrers: $referrers, paths: $paths, stars: $stars, forks: $forks}')

          # Duplikat-Check (nicht doppelt speichern wenn am selben Tag nochmal läuft)
          if grep -q "\"date\":\"$DATE\"" .github/traffic/traffic.jsonl 2>/dev/null; then
            echo "Data for $DATE already exists, skipping."
          else
            echo "$SNAPSHOT" >> .github/traffic/traffic.jsonl
            echo "Added traffic data for $DATE"
          fi

      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/traffic/
          git diff --cached --quiet || git commit -m "chore: update traffic data ($(date -u +%Y-%m-%d))"
          git push
